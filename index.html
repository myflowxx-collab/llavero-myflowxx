<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Myflowxx - Tu Número de la Suerte</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            overflow: hidden; /* Evita el desbordamiento y las barras de desplazamiento */
        }
        #three-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; /* Detrás del contenido */
        }
        .content-container {
            position: relative;
            z-index: 2; /* Delante del canvas */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
            padding: 1rem;
            color: white;
        }
        .orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .glowing-text {
            text-shadow: 0 0 5px #4ade80, 0 0 10px #4ade80, 0 0 20px #4ade80, 0 0 40px #4ade80;
        }
        .number-box {
            border: 4px solid #f87171;
            box-shadow: 0 0 10px #f87171, 0 0 20px #f87171, inset 0 0 10px #f87171;
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 10px #f87171, 0 0 20px #f87171, inset 0 0 10px #f87171;
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 20px #ef4444, 0 0 40px #ef4444, inset 0 0 20px #ef4444;
            }
        }
        /* Efecto de partículas de fondo */
        .particle {
            position: absolute;
            background: #4ade80;
            border-radius: 50%;
            opacity: 0;
            animation: rise 10s infinite linear;
        }
        @keyframes rise {
            0% {
                transform: translateY(0);
                opacity: 0.5;
            }
            100% {
                transform: translateY(-100vh);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-900">

    <div id="particle-container"></div>
    <canvas id="three-canvas"></canvas>

    <div class="content-container">
        <!-- Contenido principal -->
        <div class="bg-black bg-opacity-60 backdrop-blur-sm p-8 rounded-2xl max-w-2xl w-full">
            <h1 class="text-2xl md:text-3xl font-bold text-green-400 glowing-text orbitron tracking-wider">
                PUEDES GANAR EL PREMIO CON EL SIGUIENTE NÚMERO
            </h1>
            <p class="text-sm text-gray-300 mt-2 mb-6 orbitron">(SOLO PARA LOS QUE ESTÁN EN MESA)</p>

            <div id="number-display" class="number-box my-4 p-6 rounded-lg w-48 h-48 mx-auto flex items-center justify-center">
                <span id="lucky-number" class="text-7xl md:text-8xl font-black text-red-400 orbitron">...</span>
            </div>
            
            <div id="message-display" class="text-red-500 font-bold mt-4 h-6"></div>
        </div>

        <!-- Slogans en la parte inferior -->
        <footer class="absolute bottom-5 left-0 right-0 text-center text-gray-400 text-xs md:text-sm space-y-2">
            <p class="font-bold orbitron tracking-widest">NOT FOR NPC´S, PARA PERSONAS QUE BUSCAN SER DIFERENTES.</p>
            <p class="font-bold glowing-text text-green-300 orbitron tracking-widest">LA ROPA ES TU TICKET...</p>
        </footer>
    </div>

    <!-- Scripts para Three.js, Firebase y lógica de la página -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { FontLoader } from 'three/addons/loaders/FontLoader.js';
        import { TextGeometry } from 'three/addons/geometries/TextGeometry.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Firebase ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'myflowxx-app-preview';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO-PROJECT" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug');

        // --- Lógica del número aleatorio con Firestore ---
        async function getUniqueNumber(userId) {
            const numberEl = document.getElementById('lucky-number');
            const messageEl = document.getElementById('message-display');
            const maxNumber = 20;

            try {
                const userNumberRef = doc(db, `artifacts/${appId}/users/${userId}/lottery/details`);
                const usedNumbersRef = doc(db, `artifacts/${appId}/public/data/lotteryData/main`);

                const userDocSnap = await getDoc(userNumberRef);
                if (userDocSnap.exists()) {
                    numberEl.textContent = userDocSnap.data().number;
                    return;
                }

                const newNumber = await runTransaction(db, async (transaction) => {
                    const usedNumbersDoc = await transaction.get(usedNumbersRef);
                    let usedNumbers = usedNumbersDoc.exists() ? usedNumbersDoc.data().numbers || [] : [];

                    if (usedNumbers.length >= maxNumber) {
                        throw new Error("All numbers assigned");
                    }

                    let generatedNumber;
                    do {
                        generatedNumber = Math.floor(Math.random() * maxNumber) + 1;
                    } while (usedNumbers.includes(generatedNumber));

                    const newUsedNumbers = [...usedNumbers, generatedNumber];
                    transaction.set(usedNumbersRef, { numbers: newUsedNumbers });
                    transaction.set(userNumberRef, { number: generatedNumber });

                    return generatedNumber;
                });
                numberEl.textContent = newNumber;
            } catch (error) {
                console.error("Error getting unique number: ", error);
                if (error.message === "All numbers assigned") {
                    numberEl.textContent = "X";
                    messageEl.textContent = "Todos los números han sido asignados.";
                } else {
                    numberEl.textContent = "!";
                    messageEl.textContent = "Error al obtener número. Intenta de nuevo.";
                }
            }
        }

        // --- Lógica de partículas ---
        function createParticles() {
            const container = document.getElementById('particle-container');
            const particleCount = 50;
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                const size = Math.random() * 5 + 1;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.bottom = `-${size}px`;
                particle.style.animationDelay = `${Math.random() * 10}s`;
                particle.style.animationDuration = `${Math.random() * 5 + 5}s`;
                container.appendChild(particle);
            }
        }

        // --- Lógica de Three.js para el texto 3D ---
        let scene, camera, renderer, textMesh;

        function initThreeJS() {
            const canvas = document.getElementById('three-canvas');
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 10;
            renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0x4ade80, 2, 100);
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);
            const pointLightRed = new THREE.PointLight(0xf87171, 2, 100);
            pointLightRed.position.set(-5, -5, 5);
            scene.add(pointLightRed);

            const fontLoader = new FontLoader();
            fontLoader.load('https://cdn.jsdelivr.net/npm/three@0.158.0/examples/fonts/helvetiker_bold.typeface.json', (font) => {
                const textGeometry = new TextGeometry('myflowxx', {
                    font: font, size: 1.5, height: 0.4, curveSegments: 12,
                    bevelEnabled: true, bevelThickness: 0.03, bevelSize: 0.02, bevelOffset: 0, bevelSegments: 5
                });
                textGeometry.center();
                const textMaterial = new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.7, roughness: 0.2 });
                textMesh = new THREE.Mesh(textGeometry, textMaterial);
                scene.add(textMesh);
            });
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (textMesh) {
                textMesh.rotation.y += 0.005;
                textMesh.rotation.x += 0.002;
            }
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- Inicialización ---
        window.addEventListener('resize', onWindowResize, false);
        
        document.addEventListener('DOMContentLoaded', () => {
            // onAuthStateChanged es la única fuente de verdad para el estado de autenticación.
            // Se activará cuando el usuario inicie sesión, ya sea anónimamente o mediante una sesión restaurada.
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // El usuario ha iniciado sesión, ahora podemos obtener su número de forma segura.
                    getUniqueNumber(user.uid);
                }
            });

            // Esta función autoejecutable solo se encarga de iniciar el proceso de inicio de sesión si es necesario.
            (async () => {
                try {
                    // Si no hay un usuario actual, inicia sesión anónimamente.
                    if (!auth.currentUser) {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                    // No es necesario un 'else', onAuthStateChanged se encargará de los usuarios que ya han iniciado sesión.
                } catch (error) {
                    console.error("Authentication failed:", error);
                    document.getElementById('message-display').textContent = "Error de autenticación.";
                }
            })();

            createParticles();
            initThreeJS();
        });
    </script>

</body>
</html>

